// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  role         Role     @default(LEARNER)
  expertiseLevel ExpertiseLevel @default(BEGINNER)
  preferences  Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  textbooks        TextbookGenerationRequest[]
  textbookRequests TextbookGenerationRequest[]
}

model Textbook {
  id              String                  @id @default(uuid())
  title           String
  description     String?
  subject         String                  @default("Physical AI & Humanoid Robotics")
  educationalLevel EducationalLevel
  language        String                  @default("en")
  status          TextbookStatus          @default(DRAFT)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  generatedAt     DateTime?
  authorId        String
  metadata        Json?

  author              User                       @relation(fields: [authorId], references: [id])
  chapters            Chapter[]
  textbookGenerationRequest TextbookGenerationRequest?
  contentValidations  ContentValidation[]
}

model Chapter {
  id                String              @id @default(uuid())
  title             String
  order             Int
  content           String
  learningObjectives  String[]
  summary           String?
  textbookId        String
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  textbook            Textbook           @relation(fields: [textbookId], references: [id], onDelete: Cascade)
  sections            Section[]
  exercises           Exercise[]
  contentValidations  ContentValidation[]
}

model Section {
  id           String              @id @default(uuid())
  title        String
  order        Int
  content      String
  chapterId    String
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  chapter           Chapter          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  exercises       Exercise[]
  contentValidations ContentValidation[]
}

model Exercise {
  id           String              @id @default(uuid())
  question     String
  options      String[]
  correctAnswer String
  explanation  String?
  difficulty   Difficulty
  sectionId    String?
  chapterId    String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  section  Section? @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  chapter  Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)
}

model TextbookGenerationRequest {
  id               String                  @id @default(uuid())
  inputPrompt      String
  parameters       Json?
  status           GenerationStatus        @default(PENDING)
  progress         Float                   @default(0)
  resultTextbookId String?
  userId           String
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  user         User       @relation(fields: [userId], references: [id])
  resultTextbook Textbook? @relation(fields: [resultTextbookId], references: [id], onDelete: SetNull)
}

model ContentValidation {
  id               String              @id @default(uuid())
  textbookId       String?
  chapterId        String?
  sectionId        String?
  validationType   ValidationType
  validationSource String
  confidenceScore  Float
  isValid          Boolean
  issues           Json?
  validatedAt      DateTime?
  createdAt        DateTime            @default(now())

  textbook Textbook? @relation(fields: [textbookId], references: [id], onDelete: SetNull)
  chapter  Chapter?  @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  section  Section?  @relation(fields: [sectionId], references: [id], onDelete: SetNull)
}

enum Role {
  LEARNER
  EDUCATOR
  ADMIN
}

enum ExpertiseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum EducationalLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum TextbookStatus {
  DRAFT
  GENERATING
  COMPLETE
  FAILED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ValidationType {
  FACTUAL
  EDUCATIONAL
  ETHICAL
}